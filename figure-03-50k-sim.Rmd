# Figure 3

> **_NOTE:_** This plot omits the non-human primate CFU and flowcytometry data
> scatter plot layer shown in the publication because we do not have permission
> to redistribute that data.

```{r imports}
#| cache: false
#| message: false
library(readr)     # read_csv
library(dplyr)
library(snakecase) # to_snake_case
library(tidyr)     # pivot_longer
library(forcats)   # fct
library(stringr)   # str_remove
library(ggplot2)
library(patchwork)
```

```{r config}
#| cache: true
#| cache.vars:
#| - dir_data
#| - ticks_per_day
#| - file_cfu
#| - file_flow
source("R/config.R")

## Files containing proprietary calibration data.  These a may or may not be
## present when generating the plot.
dir_data_proprietary <-
  file.path("~/immunology/GR-ABM-ODE/simulation/scripts",
            "calibration/abc/src/gransimcal/data")
file_cfu <-
  file.path(dir_data_proprietary, "CombinedCFU_updateUponMoreData.csv")
file_flow <-
  file.path(dir_data_proprietary, "ModelCalibrationCountLung_2018.csv")
```

```{r prepare-inputs-temporal}
#| cache: true
#| dependson: -1
file_stat <-
  file.path(dir_data,
            "2024-07-19-A-gr-50k",
            "output-lhs-stat-cols-35.csv.gz")

df_runs <-
  ## Read in the data with minimal changes.
  read_csv(file_stat,
           col_types = c(exp = "c", time = "i"),
           show_col_types = FALSE) %>%
  ## Convert ticks to days.
  mutate(time = time / ticks_per_day)
df_runs

## Labels to remap the outputs for plotting.
outputs <-
  c(mac_scaled_ring = "Macrophages",
    tc_scaled_ring = "T cells",
    tot_mtb_in_gran_scaled_ring = "CFU")
df_std <-
  df_runs %>%
  ## Remove spaces and dots from column names.
  rename_with(to_snake_case) %>%
  ## Classify by Mtb level.
  group_by(exp) %>%
  mutate(classif =
         case_when(
           tot_mtb_in_gran_scaled_ring[time == max(time)] == 0
           ~ "Sterile",
           max(diff(tot_mtb_in_gran_scaled_ring[time >= max(time) - 20L &
                                                  time <= max(time)])) < 50
           ~ "Controlling",
           .default = "Uncontrolled"
         ) %>%
         fct(levels = c("Uncontrolled", "Sterile", "Controlling")),
         .before = time) %>%
  ungroup() %>%
  ## Sum T cell counts.
  mutate(exp = fct(exp),
         tc_scaled_ring = c(tgam_scaled_ring +
                              tcyt_scaled_ring +
                              treg_scaled_ring)) %>%
  ## Subset to relevant data.
  dplyr::select(exp:time, ends_with("ring")) %>%
  ## Convert to long format for ploting.
  pivot_longer(-c(exp:time), names_to = "output") %>%
  dplyr::filter(output %in% names(outputs)) %>%
  ## Use labels.
  mutate(output = outputs[output])
df_std
```

```{r prepare-inputs-proprietary}
#| cache: true
#| dependson: -1
#| eval: |
#|   `all(file.exists(file_cfu, file_flow))`
## Read in reference CFU and flowcytometry datasets.
df_cfu <-
  read_csv(file_cfu, col_select = c(3, 1, 2), show_col_types = FALSE) %>%
  rename_with(to_snake_case) %>%
  ## Remove single outlier diameter.
  dplyr::filter(granuloma_diameter_mm >= 0.5) %>%
  select(-granuloma_diameter_mm) %>%
  pivot_longer(-time, names_to = "output") %>%
  ## Ignore sterilization for now.
  dplyr::filter(value > 0)
df_flow <-
  read_csv(file_flow, show_col_types = FALSE) %>%
  ## Map columns to GranSim agents.
  dplyr::rename(time = Timepoint,
                tc_scaled_ring = "CD3") %>%
  mutate(mac_scaled_ring = `CD11b+` - `CD11b+/Calp+`) %>%
  ## Remove untreated control.
  dplyr::filter(time > 0) %>%
  dplyr::select(time, any_of(names(outputs))) %>%
  pivot_longer(-time, names_to = "output")
```

```{r plot-temporal}
#| cache: true
#| dependson:
#| - -2
#| - -1
#| fig.width: 6.5
#| fig.height: 3
plot_time <-
  df_std %>%
  mutate(time = time / 7) %>%
  ggplot(aes(x = time,
             y = value)) +
  facet_grid(~ output,
             scales = "free_y") +
  labs(x = "Week (post-infection)",
       y = "Cell counts",
       color = "Classification") +
  theme_bw() +
  ## The subsequent geom_line(linewidth = 0.1, ...) setting will make the
  ## legend harder to see, so reset the legend to the default linewidth.
  guides(color = guide_legend(override.aes = list(linewidth = 1))) +
  scale_y_log10(labels = scales::label_log()) +
  ## Reorder the legend to match how the classifications appear in the plot.
  scale_color_discrete(breaks = c("Uncontrolled", "Controlling", "Sterile")) +
  geom_line(linewidth = 0.1,
            aes(group = exp,
                color = classif))
## Overlay the proprietary data if it is accessible.
if (all(c("df_cfu", "df_flow") %in% ls())) {
  plot_time <-
    plot_time +
    geom_point(data =
                 bind_rows(df_cfu, df_flow) %>%
                 mutate(output = outputs[output],
                        time = time / 7),
               size = 0.5)
}
plot_time
```

```{r plot-spatial}
#| cache: true
#| fig.width: 6.5
#| fig.height: 4.5
load("data/mibi_cells.rda")
gr_mac <- c(
  "CD206+_Mac",
  "CD11c+_Mac",
  "CD14+_Mac_Mono",
  "CD163+Mac",
  "CD14+CD11c+_Mac",
  "CD68+_Mac",
  "FN1+_Mac"
)
df_cells <-
  mibi_cells %>%
  ## Only choose non-sterilizing granulomas with a single necrotic core.
  filter(sample == "sample9") %>%
  mutate(agent = case_when(
    cell_type %in% gr_mac ~ "Macrophages",
    cell_type == "CD4+Tcell" ~ "CD4+ T cells",
    cell_type == "CD8+Tcell" ~ "CD8+ T cells",
    cell_type == "HLADR+_APC" ~ "Dendritic cells",
    str_detect(cell_type, "Fibro$") ~ "Fibroblasts",
    str_detect(cell_type, "Neutrophil") ~ "Neutrophils",
    .default = "Other cells"))
names <-
  c("Macrophages", "CD4+ T cells", "CD8+ T cells", "Dendritic cells",
    "Fibroblasts", "Neutrophils", "Other cells")
colors <- scales::hue_pal()(
  length(names) - 1) %>%
  ## Other (O) agents not represented in GranSim should be gray.
  append("#BBBBBB")
colors <- setNames(colors[c(5, 3, 1, 2, 6, 4, 7)], names)
## Plot image of binned agents.
plot_space <-
  df_cells %>%
  mutate(sample = fct_relabel(sample, ~ str_c("MIBI-TOF ", .x)),
         agent = factor(agent, names)) %>%
  ggplot(aes(x, y, color = agent)) +
  facet_wrap(~ fct_reorder(sample, as.integer(str_extract(sample, "\\d+"))),
             ncol = 6, scales = "free") +
  geom_point(size = 0.5, data = . %>% filter(agent == "Other")) +
  geom_point(size = 0.5, data = . %>% filter(agent != "Other")) +
  scale_color_manual(values = colors) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.text = element_text(hjust = 0)) +
  labs(color = "Agent") +
  ## Increase size of points in legend https://stackoverflow.com/a/15059196
  guides(color = guide_legend(override.aes = list(size = 5)))
plot_space
```

```{r figure-03-50k-sim}
#| cache: true
#| dependson:
#| - -2
#| - -1
#| fig.width: 6.5
#| fig.height: 6
plot_space /
  plot_time +
  plot_layout(heights = c(4.5, 1.5)) +
  plot_annotation(tag_levels = "A")
```

```{r session-info}
#| cache: false
sessionInfo()
```
